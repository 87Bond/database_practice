# 模块接口说明（与当前代码一致）

## 1）账号与鉴权

- **患者注册** `POST /api/auth/patient/register`  
  入参：`patientName, gender, age, phone, password, idCard`  
  出参：`userId, createTime`

- **登录** `POST /api/auth/login`  
  入参：`id`（UserID 或手机号）、`password`  
  出参：`userId, username, role(patient|doctor|dept_manager|admin), deptId(医生/科室管理员), token`

- **修改密码** `POST /api/auth/change-password`  
  入参：`oldPassword, newPassword`

## 2）基础数据

- **科室列表** `GET /api/departments`  
  可选 `keyword`；返回 `departmentId, departmentName, location`

- **医生列表（含可约号源）** `GET /api/doctors`  
  参数：`departmentId`（必选，用于挂号页）、`date`（必选，用于号源过滤）  
  返回：医生基本信息 + `availableSlots`（`slotId, label(09:00-10:00), startTime, endTime, remain`）

## 3）号源与挂号

- **按科室/日期查询号源** `GET /api/registrations/slots`  
  参数：`date`、`departmentId`、`doctorId`(可选)  
  返回：每个号源 `slotId, startTime, endTime, label, fee(分), remain`

- **创建挂号** `POST /api/registrations`  
  入参：`doctorId, departmentId, regDate, slotId`（必须）  
  规则：  
  - 不可预约过去的日期；  
  - 号源容量校验，患者在同一号源只能有一条未取消记录；  
  - `reg_fee` 取自号源 `fee`；`reg_time_slot` 统一保存为 “HH:mm-HH:mm”。  
  出参：`regId, regStatus(Booked), regFee, payStatus(Unpaid), createTime`

- **支付挂号费** `POST /api/registrations/{regId}/pay?payChannel=Balance`  
  从患者余额扣除 `reg_fee`，余额不足报错；`payStatus -> Paid`，记录 `paidAt`。

- **取消挂号** `POST /api/registrations/{regId}/cancel`  
  `regStatus -> Canceled`；已支付按 90% 退款，未支付直接取消；释放号源已预约数。

- **患者挂号记录** `GET /api/registrations`  
  返回字段：`regId, regDate, regTimeSlot(HH:mm-HH:mm), departmentId/Name/Location, doctorId/Name, regFee, regStatus, payStatus`。

- **医生查看自己的挂号列表** `GET /api/doctor/registrations?date=`  
  返回当天/指定日期患者的 `regId, patientId/Name, regDate, regTimeSlot, regStatus, payStatus`。

- **科室管理员查看本科室挂号** `GET /api/dept/registrations?date=`  
  返回该科室所有医生的挂号记录。

## 4）号源管理（科室管理员）

- **医生列表（本科室）** `GET /api/dept/doctors`
- **加入已有医生到本科室** `POST /api/dept/doctors/{doctorId}/assign`
- **创建号源** `POST /api/dept/slots`  
  入参：`doctorId, slotDate, startTime, endTime, capacity, feeYuan, note`  
  校验：时间不得重叠，start < end，capacity>0。
- **查看号源** `GET /api/dept/slots?date=`  
  返回：`doctorId/Name, slotDate, startTime, endTime, fee(分), capacity, bookedCount, status, note`。

## 5）病历 / 就诊记录

- **医生写病历** `POST /api/medical-records`  
  入参：`regId, diagnosis, treatmentPlan, advice`
- **患者查看就诊记录** `GET /api/medical-records`  
  返回：`regDate, regTimeSlot, departmentName/Location, doctorName, diagnosis, advice`
- **医生查看自己写的病历** `GET /api/medical-records/doctor`

## 6）消息（站内信）

- **发送消息** `POST /api/messages`  
  入参：`targetUserId, title, content`  
  权限与时效：  
  - 必须存在已支付挂号的关联关系（患者↔医生/科室管理员；医生↔患者；科室管理员↔本科室医生/患者）。  
  - 如果双方最近一条消息时间超过 10 天，不允许再发送（历史可查看）。
- **收件箱/发件箱** `GET /api/messages?box=inbox|outbox&isValid=`  
- **会话列表（最近一条）** `GET /api/messages/conversations`（左侧会话，按时间倒序，含姓名+ID）  
- **会话明细** `GET /api/messages/conversation?targetUserId=...`  
- **作废消息** `POST /api/messages/{messageId}/invalidate`

## 7）账户余额（患者）

- **查询余额** `GET /api/patient/me` → `balance`
- **充值** `POST /api/patient/recharge` 入参：`amount`（元）

## 8）系统/角色管理（系统管理员）

- 创建医生/科室管理员/系统管理员账号：`POST /api/users/doctors`、`/api/users/dept-managers`、`/api/users/system-users`
- 冻结/解冻账号：`POST /api/users/{userId}/freeze`，`POST /api/users/{userId}/unfreeze`
