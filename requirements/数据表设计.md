## 数据表设计（与当前代码一致）

| 表名 | 核心字段 | 主键/外键 | 说明与约束 |
| --- | --- | --- | --- |
| **user_directory** | user_id, user_name, phone, password, create_time, is_active | PK: user_id | 统一用户基表；患者/医生/科室管理员/系统管理员共用 |
| **patient** | user_id, gender, age, id_card, money | PK/FK: user_id → user_directory | 患者扩展信息；money 单位分 |
| **doctor** | user_id, doctor_name, department_id, title, specialty, work_phone | PK/FK: user_id → user_directory；FK: department_id → department | 医生信息 |
| **department** | department_id, department_name, introduction, location | PK: department_id | 科室主数据 |
| **department_manager** | user_id, department_id, work_phone | PK/FK: user_id → user_directory；FK: department_id → department | 科室管理员 |
| **\"system_user\"** | user_id, work_phone | PK/FK: user_id → user_directory | 系统管理员/前台等 |
| **doctor_time_slot** | slot_id, doctor_id, department_id, slot_date, time_slot, start_time, end_time, capacity, booked_count, fee, status, note, create_time, update_time | PK: slot_id；FK: doctor_id → doctor；department_id → department | 号源定义；fee 单位分；时间不得重叠；start < end |
| **registration** | reg_id, patient_id, doctor_id, department_id, reg_date, reg_time_slot, reg_status, reg_fee, pay_status, create_time, paid_at, slot_id | PK: reg_id；FK: patient_id → patient；doctor_id → doctor；department_id → department；slot_id → doctor_time_slot | 挂号记录；reg_fee 单位分；reg_status: Booked/Canceled/Finished；pay_status: Unpaid/Paid/Refunded |
| **medical_record** | record_id, reg_id, diagnosis, treatment_plan, advice, create_time | PK: record_id；FK(unique): reg_id → registration | 挂号关联的病历 |
| **message** | message_id, title, content, create_user_id, target_user_id, create_time, is_valid | PK: message_id；FK: create_user_id/target_user_id → user_directory | 站内消息；is_valid 逻辑删除/撤回 |
| **audit_log** | log_id, user_id, action, target, time | PK: log_id | 操作审计 |

### 关键说明
- **号源费用**：`doctor_time_slot.fee`（分），挂号时复制到 `registration.reg_fee`。
- **时间段展示**：`doctor_time_slot.time_slot` / `registration.reg_time_slot` 保存人类可读的 “HH:mm-HH:mm”。
- **唯一性/限制**：
  - 同一患者同一 `slot_id` 只能有一条未取消的挂号。
  - 号源容量控制：`capacity > booked_count` 才可预约。
  - 取消已支付时按 90% 退款。
