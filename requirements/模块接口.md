# 1）账号 & 鉴权

## 学员/患者注册接口

- 接口名称：`PatientRegister`
- 接口地址：`POST /api/auth/patient/register`
- 输入方式：`POST/json`
- 输入数据：
  - `patientName`、`gender`、`age`、`phone`、`password`、`idCard`
- 返回：

```
{ "error_code": 0, "msg": "注册成功", "data": { "userId": "P202311010001", "createTime": "2025-11-08T09:30:00" } }
```

- 可能错误：

```
{ "error_code": 101, "msg": "手机号已存在" }
```

## 登录接口（患者/医生/科室管理员/系统用户通用）

- 接口名称：`UserLogin`
- 接口地址：`POST /api/auth/login`
- 输入数据：`id`（UserID/手机号/工号均可按实现约定），`password`
- 返回（密码错误/帐号不存在/成功）：

```
{ "error_code": 1, "msg": "账号不存在" }
{ "error_code": 2, "msg": "密码错误，请重新输入" }
{
  "error_code": 0,
  "msg": "登录成功",
  "data": {
    "userId": "P202311010001",
    "username": "张三",
    "role": "patient",        // patient | doctor | dept_manager | admin
    "deptId": "D001",         // 仅医生/科室管理员返回
    "activity_time": "30m",
    "token": "jwt-token..."
  }
}
```

## 修改密码

- 接口名称：`ChangePassword`
- 接口地址：`POST /api/auth/change-password`
- 输入数据：`oldPassword`，`newPassword`
- 返回：

```
{ "error_code": 0, "msg": "修改成功" }
{ "error_code": 2, "msg": "原密码错误" }
```

------

# 2）查询（按时间段/科室）、挂号、取消号、支付

## 查询科室列表

- 名称：`ListDepartments`
- 地址：`GET /api/departments`
- 查询参数：`keyword`（可选）
- 返回：

```
{
  "error_code": 0,
  "msg": "ok",
  "data": [
    { "departmentId": "D001", "departmentName": "内科", "location": "门诊楼3F" },
    { "departmentId": "D002", "departmentName": "外科", "location": "门诊楼4F" }
  ]
}
```

## 查询医生（可按科室、日期筛可约时段）

- 名称：`ListDoctors`
- 地址：`GET /api/doctors`
- 参数：`departmentId`（可选），`date`（可选）
- 返回要点：医生基本信息 + 当天/该日可约时段（结合 `Registration.RegTimeSlot`）

```
{
  "error_code": 0, "msg": "ok",
  "data": [
    {
      "userId": "DR0001", "doctorName": "李医生", "departmentId": "D001", "title": "主任医师",
      "specialty": "呼吸内科",
      "availableTimeSlots": ["AM-1","AM-2","PM-1"]     // 当传入 date 时返回
    }
  ]
}
```

## 查询号源（按时间段 & 科室，必要时也可按医生）

- 名称：`QuerySlots`
- 地址：`GET /api/registrations/slots`
- 参数：`date`（必填），`departmentId`（必填），`doctorId`（可选）
- 返回：

```
{
  "error_code": 0,"msg": "ok",
  "data": {
    "date": "2025-11-12",
    "departmentId": "D001",
    "doctorId": "DR0001",
    "slots": [
      { "timeSlot": "AM-1", "remain": 3 },
      { "timeSlot": "AM-2", "remain": 0 },
      { "timeSlot": "PM-1", "remain": 5 }
    ]
  }
}
```

## 挂号（创建就诊登记）

- 名称：`CreateRegistration`
- 地址：`POST /api/registrations`
- 输入：`patientId`（默认取 token 用户）、`doctorId`、`departmentId`、`regDate`、`regTimeSlot`
- 返回：

```
{
  "error_code": 0,
  "msg": "挂号成功",
  "data": {
    "regId": "R202511120001",
    "regStatus": "Booked",      // Booked | Canceled | Finished
    "regFee": 3000,             // 单位分
    "payStatus": "Unpaid",      // Unpaid | Paid | Refunded
    "createTime": "2025-11-08T10:00:00"
  }
}
```

- 典型错误：

```
{ "error_code": 301, "msg": "该时段号源不足" }
{ "error_code": 302, "msg": "医生不属于该科室" }
```

## 取消号

- 名称：`CancelRegistration`
- 地址：`POST /api/registrations/{regId}/cancel`
- 返回：

```
{ "error_code": 0, "msg": "已取消", "data": { "regStatus": "Canceled", "payStatus": "Refunded" } }
{ "error_code": 303, "msg": "已过可取消时间" }
```

## 支付挂号费（可选）

- 名称：`PayRegistration`
- 地址：`POST /api/registrations/{regId}/pay`
- 输入：`payChannel`（如 `WeChat`/`Alipay`）
- 返回：

```
{ "error_code": 0, "msg": "支付成功", "data": { "payStatus": "Paid", "paidAt": "2025-11-08T10:05:00" } }
```

## 挂号记录查询（按时间段/状态/科室）

- 名称：`ListRegistrations`
- 地址：`GET /api/registrations`
- 参数（均可选）：`patientId`（默认当前用户）、`from`、`to`、`departmentId`、`status`
- 返回：

```
{
  "error_code": 0, "msg": "ok",
  "data": [
    {
      "regId": "R202511120001",
      "regDate": "2025-11-12",
      "regTimeSlot": "AM-1",
      "departmentId": "D001",
      "doctorId": "DR0001",
      "regStatus": "Booked",
      "payStatus": "Paid"
    }
  ]
}
```

------

# 3）消息（Message）

## 发送消息

- 名称：`SendMessage`
- 地址：`POST /api/messages`
- 输入：`title`，`content`，`targetUserId`（或 `targetRole` 批量）
- 规则映射表结构：`Message(CreateUserID, TargetUserID, Title, Content, IsValid)`
- 返回：

```
{
  "error_code": 0, "msg": "发送成功",
  "data": { "messageId": "M202511080001", "createTime": "2025-11-08T10:10:00" }
}
```

## 收件箱/发件箱

- 名称：`ListMessages`
- 地址：`GET /api/messages`
- 参数：`box=inbox|outbox`（默认 `inbox`），`isValid=true|false`（默认 true）
- 返回：

```
{
  "error_code": 0, "msg": "ok",
  "data": [
    {
      "messageId": "M202511080001",
      "title": "就诊提醒",
      "content": "请提前10分钟到达门诊楼3F。",
      "createUserId": "DR0001",
      "targetUserId": "P202311010001",
      "createTime": "2025-11-08T10:10:00",
      "isValid": true
    }
  ]
}
```

## 作废/撤回消息（置 `IsValid=false`）

- 名称：`InvalidateMessage`
- 地址：`POST /api/messages/{messageId}/invalidate`
- 返回：

```
{ "error_code": 0, "msg": "已作废", "data": { "isValid": false } }
```

------

# 4）冻结 / 解冻（IsActive 字段）

> 仅管理员或科室管理员可操作；对象可为患者/医生/科室管理员。

## 冻结

- 名称：`FreezeUser`
- 地址：`POST /api/users/{userId}/freeze`
- 返回：

```
{ "error_code": 0, "msg": "已冻结", "data": { "userId": "P202311010001", "isActive": false } }
```

## 解冻

- 名称：`UnfreezeUser`
- 地址：`POST /api/users/{userId}/unfreeze`
- 返回：

```
{ "error_code": 0, "msg": "已解冻", "data": { "userId": "P202311010001", "isActive": true } }
```

------

## 统一错误码建议（可扩展）

- `0` 成功
- `1` 账号不存在
- `2` 密码错误
- `101` 手机号/证件号已存在
- `201` 无权限
- `301` 号源不足
- `302` 医生与科室不匹配
- `303` 超过可取消时间
- `400` 参数错误
- `500` 服务器内部错误

------

## 备注（与表结构的映射）

- `Patient/Doctor/DepartmentManager/SystemUser` → 统一抽象为“用户”，鉴权返回 `role`。
- `Registration`：创建/取消/支付接口直接维护 `RegStatus`、`PayStatus`、`RegTimeSlot`。
- `Message`：`CreateUserID` 来自 token，`IsValid` 支持撤回/删除视图。
- `Department`：供医生/号源查询。