# 医院挂号系统需求（与当前实现对齐版）

## 一、角色与权限

| 角色 | 能力 |
| --- | --- |
| 患者 | 注册/登录；选科室+日期挂号；支付/取消；查看挂号与就诊记录；充值余额；向就诊医生/科室管理员发送站内消息（需有付费挂号，且双方 10 天内有消息往来）；查看系统消息 |
| 医生 | 查看当天挂号患者列表；向患者/科室管理员/系统管理员发消息（患者需有付费挂号，消息 10 天内活跃）；编写病历；查看自己的挂号/病历列表 |
| 科室管理员 | 维护本科室医生（加入/调整科室）；为医生创建号源（日期、起止时间、容量、费用、备注）；查看本科室号源与挂号记录；向本科室医生、在本科室有付费挂号的患者发消息 |
| 系统管理员 | 创建医生/科室管理员/系统管理员账号；初始化科室数据；冻结/解冻账号；发送系统通知 |

## 二、主要功能

- 公共：登录/注册、修改密码、退出；所有接口前缀 `/api`。
- 挂号（患者）：
  - 选择科室 + 日期，系统返回可约医生及其号源（含起止时间、剩余量、费用）。
  - 创建挂号：必须选择具体 `slotId`；同一患者同一号源仅能有 1 条未取消的挂号；不可预约过去的日期。
  - 支付：从余额扣除 `reg_fee`（单位分）；余额不足提示充值。
  - 取消：已支付按 90% 退款，未支付直接取消；同时释放号源已预约数。
- 号源管理（科室管理员）：
  - 创建号源：医生、日期、开始/结束时间、容量、费用（元）、备注；时间不得重叠，`start < end`。
  - 查看号源列表：医生、日期、时间段、费用、容量、已预约、状态、备注。
  - 查看本科室挂号记录：可一键填充消息收件人。
- 病历/就诊记录：
  - 医生为挂号写病历：诊断、治疗方案、医嘱。
  - 患者在“个人中心”查看就诊记录（含医生/科室名称、地点）。
  - 医生在“医生端”查看自己写过的病历。
- 消息（站内信）：
  - 前置关系：必须存在已支付的挂号记录（患者 ↔ 医生/科室管理员；医生 ↔ 患者；科室管理员 ↔ 本科室医生/患者）。
  - 时效：双方最近一条消息时间超过 10 天则禁止再发送（历史可查看）；需重新挂号或联系管理员。
  - 会话列表按最近消息时间倒序，显示姓名 + ID（医生附带科室）。

## 三、核心数据实体（与代码一致）

- `user_directory`：`user_id, user_name, phone, password, create_time, is_active`
- `patient`：`user_id(PK/FK), gender, age, id_card, money(分)`
- `doctor`：`user_id(PK/FK), doctor_name, department_id, title, specialty, work_phone`
- `department`：`department_id, department_name, introduction, location`
- `department_manager`：`user_id(PK/FK), department_id, work_phone`
- `"system_user"`：`user_id(PK/FK), work_phone`
- `doctor_time_slot`：`slot_id, doctor_id, department_id, slot_date, time_slot(展示), start_time, end_time, capacity, booked_count, fee(分), status, note, create_time, update_time`
- `registration`：`reg_id, patient_id, doctor_id, department_id, reg_date, reg_time_slot(展示), reg_status, reg_fee(分), pay_status, create_time, paid_at, slot_id`（查询时附带 `doctor_name/department_name/location`）
- `medical_record`：`record_id, reg_id, diagnosis, treatment_plan, advice, create_time`
- `message`：`message_id, title, content, create_user_id, target_user_id, create_time, is_valid`
- `audit_log`：`log_id, user_id, action, target, time`

## 四、关键约束与规则

- 号源时间不可重叠；容量>0；`start_time < end_time`。
- 挂号日期不得早于今天；号源余量不足禁止挂号；同一患者同一号源最多一条未取消记录。
- 支付前校验余额；取消已支付按 90% 退款。
- 消息权限：需存在付费挂号关系，且双方最近消息时间≤10天；超 10 天禁止新发，历史可查。

## 五、前端导航（登录后按角色展示）

- 患者：挂号 / 消息 / 个人中心
- 医生：消息 / 个人中心 / 医生端
- 科室管理员：消息 / 个人中心 / 科室端
- 系统管理员：消息 / 个人中心 / 系统管理
